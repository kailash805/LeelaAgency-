<!DOCTYPE html>
<html>
<head>
  <title>Secure 5 Item Entry + Refund System</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: Arial; margin:20px; }
    input, select { padding:10px; margin:5px 0; display:block; font-size:16px; width:250px; }
    button { padding:10px 20px; margin:5px 0; cursor:pointer; font-size:16px; }
    table { border-collapse: collapse; margin-top:10px; width:100%; max-width:500px; }
    th, td { padding:8px; border:1px solid #ccc; text-align:left; }
    .pending { background:#fff3cd; padding:10px; margin:5px 0; }
    .confirmed { background:#d4edda; padding:10px; margin:5px 0; }
    .refundBox { background:#f8d7da; padding:10px; margin:5px 0; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login</h2>
  <input type="text" id="mobile" placeholder="Mobile Number">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">

  <h3>Welcome: <span id="userRole"></span></h3>
  <button onclick="logout()">Logout</button>

  <!-- ✅ ENTRY SECTION WRAPPED -->
  <div id="entrySection">
    <h2>5 Fixed Items Entry (Only C)</h2>
    <table id="itemTable">
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Qty</th>
      </tr>
    </table>
    <button id="submitBtn" onclick="submitData()">Submit</button>
  </div>

  <hr>
  <h3>Grand Total: ₹<span id="grandTotal">0</span></h3>

  <hr>
  <h2 id="refundTitle" style="display:none;">Refund Panel (Only C)</h2>
  <div id="refundSection" style="display:none;">
    <select id="refundEntry"></select>
    <select id="refundItem"></select>
    <input type="number" id="refundQty" placeholder="Refund Qty">
    <button onclick="submitRefund()">Submit Refund</button>
  </div>

  <hr>
  <h2>All Entries</h2>
  <div id="entries"></div>

  <hr>
  <h2>Refund History</h2>
  <div id="refundHistory"></div>

</div>

<script>
// Firebase Config (same as yours)
var firebaseConfig = {
  apiKey: "AIzaSyDeWeYu7mOaPcrDnqnTFZudck8tRU1az-M",
  authDomain: "myapp-a3d28.firebaseapp.com",
  databaseURL: "https://myapp-a3d28-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myapp-a3d28",
  storageBucket: "myapp-a3d28.firebasestorage.app",
  messagingSenderId: "528024303624",
  appId: "1:528024303624:web:0c5e552d636fd2c93e39bd"
};
firebase.initializeApp(firebaseConfig);
var database = firebase.database();

// Users
var users = {
  "9111111111": { role: "A", password: "1234" },
  "9222222222": { role: "B", password: "1234" },
  "9988770000": { role: "C", password: "1234" }
};

// Prices
var prices = {
  "200 G":20,
  "600 G":51,
  "Pizza":35,
  "Bhajipav":45,
  "Braun 400 G":50
};

let currentUser = "";

// Generate Table
let table = document.getElementById("itemTable");
for(let item in prices){
  table.innerHTML += `
    <tr>
      <td>${item}</td>
      <td>₹${prices[item]}</td>
      <td><input type="number" id="${item}" min="0"></td>
    </tr>
  `;
}

// LOGIN
function login(){
  let mobile = document.getElementById("mobile").value.trim();
  let password = document.getElementById("password").value.trim();

  if(users[mobile] && users[mobile].password === password){
    currentUser = users[mobile].role;

    document.getElementById("loginSection").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("userRole").innerText = currentUser;

    // ✅ Hide entry section for A/B
    if(currentUser !== "C"){
      document.getElementById("entrySection").style.display = "none";
    }

    if(currentUser === "C"){
      document.getElementById("refundSection").style.display = "block";
      document.getElementById("refundTitle").style.display = "block";

      let refundItem = document.getElementById("refundItem");
      refundItem.innerHTML = "";
      for(let item in prices){
        refundItem.innerHTML += `<option value="${item}">${item}</option>`;
      }
    }

    loadEntries();
    loadRefundHistory();

  } else {
    alert("Invalid Mobile or Password");
  }
}

// LOGOUT
function logout(){ location.reload(); }

// SUBMIT ENTRY
function submitData(){
  if(currentUser !== "C") return;

  let entryData = {};
  let total = 0;

  for(let item in prices){
    let qty = parseInt(document.getElementById(item).value) || 0;
    entryData[item] = qty;
    total += qty * prices[item];
  }

  if(total === 0){ alert("Enter quantity"); return; }

  database.ref("entries").push({
    items: entryData,
    total: total,
    timestamp: Date.now(),
    status: "pending"
  });
}

// LOAD ENTRIES
function loadEntries(){
  database.ref("entries").on("value", function(snapshot){
    let data = snapshot.val() || {};
    let html = "";
    let totalConfirmed = 0;
    let refundDropdown = document.getElementById("refundEntry");
    refundDropdown.innerHTML = "";

    for(let id in data){
      let entry = data[id];
      let date = new Date(entry.timestamp);

      html += `<div class="${entry.status}">
      <b>Date:</b> ${date.toLocaleString()}<br>`;

      for(let item in entry.items){
        if(entry.items[item] > 0){
          html += `${item}: ${entry.items[item]}<br>`;
        }
      }

      html += `<b>Total:</b> ₹${entry.total}<br>
               <b>Status:</b> ${entry.status}`;

      if((currentUser === "A" || currentUser === "B") && entry.status === "pending"){
        html += `<br><button onclick="confirmEntry('${id}')">Confirm</button>`;
      }

      if(entry.status === "confirmed"){
        totalConfirmed += entry.total;

        if(currentUser === "C"){
          refundDropdown.innerHTML += 
            `<option value="${id}">${date.toLocaleDateString()} - ₹${entry.total}</option>`;
        }
      }

      html += `</div>`;
    }

    document.getElementById("entries").innerHTML = html;
    document.getElementById("grandTotal").innerText = totalConfirmed;
  });
}

// CONFIRM
function confirmEntry(id){
  database.ref("entries/" + id).update({ status:"confirmed" });
}

// ✅ REFUND WITH DUPLICATE CHECK
function submitRefund(){

  let entryId = document.getElementById("refundEntry").value;
  let item = document.getElementById("refundItem").value;
  let qty = parseInt(document.getElementById("refundQty").value);

  if(!entryId || !item || !qty){
    alert("Fill all refund details");
    return;
  }

  // Check duplicate refund
  database.ref("refunds")
  .orderByChild("entryId")
  .equalTo(entryId)
  .once("value", function(snapshot){

    let data = snapshot.val();

    if(data){
      for(let id in data){
        if(data[id].item === item){
          alert("Duplicate refund not allowed for same item.");
          return;
        }
      }
    }

    let amount = qty * prices[item];

    database.ref("refunds").push({
      entryId: entryId,
      item: item,
      qty: qty,
      amount: amount,
      timestamp: Date.now()
    });

    alert("Refund Saved");
  });
}

// LOAD REFUND HISTORY
function loadRefundHistory(){
  database.ref("refunds").on("value", function(snapshot){
    let data = snapshot.val() || {};
    let html = "";

    for(let id in data){
      let refund = data[id];
      let date = new Date(refund.timestamp);

      html += `<div class="refundBox">
        <b>Refund Date:</b> ${date.toLocaleString()}<br>
        <b>Item:</b> ${refund.item}<br>
        <b>Qty:</b> ${refund.qty}<br>
        <b>Amount:</b> ₹${refund.amount}
      </div>`;
    }

    document.getElementById("refundHistory").innerHTML = 
      html || "No refund yet.";
  });
}
</script>
</body>
</html>
