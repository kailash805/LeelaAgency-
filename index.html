<script>

// üî• Firebase Config
var firebaseConfig = {
  apiKey: "AIzaSyDeWeYu7mOaPcrDnqnTFZudck8tRU1az-M",
  authDomain: "myapp-a3d28.firebaseapp.com",
  databaseURL: "https://myapp-a3d28-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myapp-a3d28",
  storageBucket: "myapp-a3d28.firebasestorage.app",
  messagingSenderId: "528024303624",
  appId: "1:528024303624:web:0c5e552d636fd2c93e39bd"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();

// üîê Users
var users = {
  "9111111111": { role: "A", password: "1234" },
  "9222222222": { role: "B", password: "1234" },
  "9988770000": { role: "C", password: "1234" }
};

// üí∞ Prices updated
var prices = {
  "200 G": 20,
  "600 G": 51,
  "Pizza": 35,
  "Bhajipav": 45,
  "Braun 400 G": 50
};

let currentUser = "";

// Generate Item Table
let table = document.getElementById("itemTable");
for(let item in prices){
  table.innerHTML += `
    <tr>
      <td>${item}</td>
      <td>‚Çπ${prices[item]}</td>
      <td><input type="number" id="${item}" min="0"></td>
    </tr>
  `;
}

// üîê LOGIN
function login(){
  let mobile = document.getElementById("mobile").value.trim();
  let password = document.getElementById("password").value.trim();

  if(users[mobile] && users[mobile].password === password){
    currentUser = users[mobile].role;
    document.getElementById("app").style.display = "block";
    document.getElementById("userRole").innerText = currentUser;

    if(currentUser !== "C"){
      document.getElementById("submitBtn").style.display = "none";
    }

    if(currentUser === "C"){
      document.getElementById("refundSection").style.display = "block";
      document.getElementById("refundTitle").style.display = "block";

      let refundItem = document.getElementById("refundItem");
      refundItem.innerHTML = "";
      for(let item in prices){
        refundItem.innerHTML += `<option value="${item}">${item}</option>`;
      }
    }

    alert("Login Successful");
    renderEntries(); // show entries on login
  } else {
    alert("Invalid Mobile or Password");
  }
}

// üìù SUBMIT ENTRY
function submitData(){
  if(currentUser !== "C"){
    alert("Only C can submit");
    return;
  }

  let entryData = {};
  let total = 0;

  for(let item in prices){
    let qty = parseInt(document.getElementById(item).value) || 0;
    entryData[item] = qty;
    total += qty * prices[item];
  }

  if(total === 0){
    alert("Enter quantity first");
    return;
  }

  database.ref("entries").push({
    items: entryData,
    total: total,
    timestamp: Date.now(),
    status: "pending",
    confirmedBy: ""
  });

  for(let item in prices){
    document.getElementById(item).value = "";
  }
}

// üìä REALTIME LISTENER
database.ref("entries").on("value", function(snapshot){
  renderEntries(snapshot);
  renderRefundHistory(snapshot);
});

// üéØ RENDER ENTRIES
function renderEntries(snapshot){
  if(!currentUser) return;

  if(!snapshot){
    database.ref("entries").once("value").then(renderEntries);
    return;
  }

  let data = snapshot.val() || {};
  let html = "";
  let totalConfirmed = 0;

  let refundEntryDropdown = document.getElementById("refundEntry");
  if(refundEntryDropdown) refundEntryDropdown.innerHTML = "";

  for(let id in data){
    let entry = data[id];
    let entryDate = new Date(entry.timestamp);

    html += `<div class="${entry.status}" style="border:1px solid #ccc; margin:5px; padding:5px;">
      <b>Date:</b> ${entryDate.toLocaleString()}<br>`;

    // Show items
    for(let item in entry.items){
      if(entry.items[item] > 0){
        html += `${item} : ${entry.items[item]} √ó ‚Çπ${prices[item]} = ‚Çπ${entry.items[item]*prices[item]}<br>`;
      }
    }

    html += `<b>Total:</b> ‚Çπ${entry.total}<br>
             <b>Status:</b> ${entry.status}<br>`;

    if(entry.status === "confirmed"){
      totalConfirmed += entry.total;
    }

    if((currentUser === "A" || currentUser === "B") 
        && entry.status === "pending"){
      html += `<button onclick="confirmEntry('${id}')">Confirm</button>`;
    }

    if(currentUser === "C" && entry.status === "pending"){
      html += `<button onclick="deleteEntry('${id}')">Delete</button>`;
    }

    html += `</div>`;
  }

  document.getElementById("entries").innerHTML = html;
  document.getElementById("grandTotal").innerText = totalConfirmed;
}

// ‚úÖ CONFIRM
function confirmEntry(id){
  database.ref("entries/" + id).update({
    status: "confirmed",
    confirmedBy: currentUser
  });
}

// ‚ùå DELETE
function deleteEntry(id){
  database.ref("entries/" + id).remove();
}

// üí∞ REFUND SYSTEM
function submitRefund(){

  let entryId = document.getElementById("refundEntry").value;
  let item = document.getElementById("refundItem").value;
  let qty = parseInt(document.getElementById("refundQty").value);

  if(!entryId || !item || !qty){
    alert("Fill all refund details");
    return;
  }

  let amount = qty * prices[item];

  database.ref("refunds").push({
    entryId: entryId,
    item: item,
    qty: qty,
    amount: amount,
    timestamp: Date.now()
  });

  alert("Refund Saved");
  document.getElementById("refundQty").value = "";
}

// üìÑ REFUND HISTORY
function renderRefundHistory(snapshot){
  let data = snapshot.val() || {};
  let html = "";

  database.ref("refunds").once("value").then(function(refundSnap){
    let refunds = refundSnap.val() || {};
    for(let id in refunds){
      let r = refunds[id];
      let entryDate = new Date(r.timestamp);
      html += `<div style="border:1px solid #f00; padding:5px; margin:5px; background:#f8d7da;">
        <b>Refund Date:</b> ${entryDate.toLocaleString()}<br>
        <b>Entry ID:</b> ${r.entryId}<br>
        <b>Item:</b> ${r.item} | <b>Qty:</b> ${r.qty} | <b>Amount:</b> ‚Çπ${r.amount}
      </div>`;
    }
    document.getElementById("refundHistory").innerHTML = html;
  });
}

     </script>
