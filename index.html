<!DOCTYPE html>
<html>
<head>
  <title>Secure 5 Item Entry + Refund System</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: Arial; margin:20px; }
    input, select { padding:10px; margin:5px 0; display:block; font-size:16px; width:250px; }
    button { padding:10px 20px; margin:5px 0; cursor:pointer; font-size:16px; }
    table { border-collapse: collapse; margin-top:10px; width:100%; max-width:500px; }
    th, td { padding:8px; border:1px solid #ccc; text-align:left; }
    .pending { background:#fff3cd; padding:10px; margin:5px 0; }
    .confirmed { background:#d4edda; padding:10px; margin:5px 0; }
    .refundBox { padding:10px; margin:5px 0; }
    .settingsBox { background:#e2e3e5; padding:10px; margin:10px 0; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login</h2>
  <input type="text" id="mobile" placeholder="Mobile Number">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">

  <h3>Welcome: <span id="userRole"></span></h3>
  <button onclick="logout()">Logout</button>
  <button id="settingsBtn" style="display:none;" onclick="toggleSettings()">⚙ Settings</button>

  <div id="settingsPanel" style="display:none;" class="settingsBox">
    <button onclick="deleteAllEntries()">Delete All Entries</button>
    <button onclick="deleteAllRefunds()">Delete All Refunds</button>
  </div>

  <div id="entrySection">
    <h2>5 Fixed Items Entry (Only C)</h2>
    <table id="itemTable">
      <tr><th>Item</th><th>Price</th><th>Qty</th></tr>
    </table>
    <button onclick="submitData()">Submit</button>
  </div>

  <hr>
  <h3>Grand Total: ₹<span id="grandTotal">0</span></h3>

  <hr>
  <h2 id="refundTitle" style="display:none;">Refund Panel (Only C)</h2>
  <div id="refundSection" style="display:none;">
    <select id="refundEntry"></select>
    <select id="refundItem"></select>
    <input type="number" id="refundQty" placeholder="Refund Qty">
    <button onclick="submitRefund()">Submit Refund</button>
  </div>

  <hr>
  <h2>All Entries</h2>
  <div id="entries"></div>

  <hr>
  <h2>Refund History</h2>
  <div id="refundHistory"></div>

</div>

<script>
var firebaseConfig = {
  apiKey: "YOUR KEY",
  authDomain: "YOUR DOMAIN",
  databaseURL: "YOUR DB URL",
};
firebase.initializeApp(firebaseConfig);
var database = firebase.database();

var users = {
  "9111111111": { role: "A", password: "1234" },
  "9222222222": { role: "B", password: "1234" },
  "9988770000": { role: "C", password: "1234" }
};

var prices = {
  "200 G":20,
  "600 G":51,
  "Pizza":35,
  "Bhajipav":45,
  "Braun 400 G":50
};

let currentUser = "";

// Generate Table
let table = document.getElementById("itemTable");
for(let item in prices){
  table.innerHTML += `
    <tr>
      <td>${item}</td>
      <td>₹${prices[item]}</td>
      <td><input type="number" id="${item}" min="0"></td>
    </tr>
  `;
}

function login(){
  let mobile = mobile.value.trim();
  let pass = password.value.trim();

  if(users[mobile] && users[mobile].password === pass){
    currentUser = users[mobile].role;
    loginSection.style.display="none";
    app.style.display="block";
    userRole.innerText=currentUser;

    if(currentUser !== "C") entrySection.style.display="none";

    if(currentUser === "C"){
      refundSection.style.display="block";
      refundTitle.style.display="block";
      settingsBtn.style.display="inline-block";

      refundItem.innerHTML="";
      for(let item in prices){
        refundItem.innerHTML += `<option value="${item}">${item}</option>`;
      }
    }

    loadEntries();
    loadRefundHistory();
  } else alert("Invalid Login");
}

function logout(){ location.reload(); }

function submitData(){
  let entryData={}, total=0;
  for(let item in prices){
    let qty=parseInt(document.getElementById(item).value)||0;
    entryData[item]=qty;
    total+=qty*prices[item];
  }
  if(total===0) return alert("Enter qty");

  database.ref("entries").push({
    items:entryData,
    total:total,
    timestamp:Date.now(),
    status:"pending"
  });
}

function loadEntries(){
  database.ref("entries").on("value", snap=>{
    let data=snap.val()||{}, html="", total=0;
    refundEntry.innerHTML="";

    for(let id in data){
      let e=data[id];
      let d=new Date(e.timestamp);

      html+=`<div class="${e.status}">
      <b>Date:</b> ${d.toLocaleString()}<br>`;

      for(let item in e.items){
        if(e.items[item]>0) html+=`${item}: ${e.items[item]}<br>`;
      }

      html+=`<b>Total:</b> ₹${e.total}<br>
             <b>Status:</b> ${e.status}`;

      if((currentUser==="A"||currentUser==="B")&&e.status==="pending")
        html+=`<br><button onclick="confirmEntry('${id}')">Confirm</button>`;

      if(e.status==="confirmed"){
        total+=e.total;
        if(currentUser==="C")
          refundEntry.innerHTML+=`<option value="${id}">
          ${d.toLocaleDateString()} - ₹${e.total}</option>`;
      }

      html+=`</div>`;
    }
    entries.innerHTML=html;
    grandTotal.innerText=total;
  });
}

function confirmEntry(id){
  database.ref("entries/"+id).update({status:"confirmed"});
}

// ===== REFUND SYSTEM WITH CONFIRM =====

function submitRefund(){
  let entryId=refundEntry.value;
  let item=refundItem.value;
  let qty=parseInt(refundQty.value);

  if(!entryId||!qty) return alert("Fill details");

  database.ref("refunds").push({
    entryId,item,qty,
    amount:qty*prices[item],
    timestamp:Date.now(),
    status:"pending"
  });
}

function loadRefundHistory(){
  database.ref("refunds").on("value",snap=>{
    let data=snap.val()||{}, html="";
    for(let id in data){
      let r=data[id];
      let d=new Date(r.timestamp);

      html+=`<div class="${r.status} refundBox">
      <b>Date:</b> ${d.toLocaleString()}<br>
      Item: ${r.item}<br>
      Qty: ${r.qty}<br>
      Amount: ₹${r.amount}<br>
      Status: ${r.status}`;

      if((currentUser==="A"||currentUser==="B")&&r.status==="pending")
        html+=`<br><button onclick="confirmRefund('${id}')">
        Confirm Refund</button>`;

      html+=`</div>`;
    }
    refundHistory.innerHTML=html||"No refund yet.";
  });
}

function confirmRefund(id){
  database.ref("refunds/"+id).update({status:"confirmed"});
}

// ===== SETTINGS =====

function toggleSettings(){
  settingsPanel.style.display=
  settingsPanel.style.display==="none"?"block":"none";
}

function deleteAllEntries(){
  if(confirm("Delete ALL entries?")){
    database.ref("entries").remove();
  }
}

function deleteAllRefunds(){
  if(confirm("Delete ALL refunds?")){
    database.ref("refunds").remove();
  }
}

</script>
</body>
</html>
