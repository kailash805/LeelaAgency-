<!DOCTYPE html>
<html>
<head>
  <title>Secure Entry + Refund System</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: Arial; margin:20px; }
    input, select { padding:12px; margin:6px 0; display:block; font-size:16px; width:280px; }
    button { padding:10px 20px; margin:6px 0; cursor:pointer; font-size:16px; }
    table { border-collapse: collapse; margin-top:10px; width:100%; max-width:500px; }
    th, td { padding:8px; border:1px solid #ccc; text-align:left; }
    .pending { background:#fff3cd; padding:10px; margin:6px 0; }
    .confirmed { background:#d4edda; padding:10px; margin:6px 0; }
    .refundBox { padding:10px; margin:6px 0; border:1px solid #ccc; }
    .settingsBox { background:#e2e3e5; padding:10px; margin:10px 0; }
  </style>
</head>
<body>

<div id="loginSection">
  <h2>Login</h2>
  <input type="text" id="mobile" placeholder="Mobile Number">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="app" style="display:none;">

  <h3>Welcome: <span id="userRole"></span></h3>
  <button onclick="logout()">Logout</button>
  <button id="settingsBtn" style="display:none;" onclick="toggleSettings()">âš™ Settings</button>

  <div id="settingsPanel" style="display:none;" class="settingsBox">
    <button onclick="deleteAllEntries()">Delete All Entries</button>
    <button onclick="deleteAllRefunds()">Delete All Refunds</button>
  </div>

  <!-- ENTRY SECTION -->
  <div id="entrySection">
    <h2>Item Entry (Only C)</h2>
    <table id="itemTable">
      <tr><th>Item</th><th>Price</th><th>Qty</th></tr>
    </table>
    <button onclick="submitData()">Submit Entry</button>
  </div>

  <hr>
  <h3>Grand Total (Confirmed Only): â‚¹<span id="grandTotal">0</span></h3>

  <hr>
  <h2 id="refundTitle" style="display:none;">Refund Panel (Only C)</h2>
  <div id="refundSection" style="display:none;">
    <select id="refundEntry"></select>
    <select id="refundItem"></select>
    <input type="number" id="refundQty" placeholder="Refund Qty">
    <button onclick="submitRefund()">Submit Refund</button>
  </div>

  <hr>
  <h2>All Entries</h2>
  <div id="entries"></div>

  <hr>
  <h2>Refund History</h2>
  <div id="refundHistory"></div>

</div>

<script>

// ðŸ”¥ PASTE YOUR ORIGINAL FIREBASE CONFIG HERE
var firebaseConfig = {
  apiKey: "AIzaSyDeWeYu7mOaPcrDnqnTFZudck8tRU1az-M",
    authDomain: "myapp-a3d28.firebaseapp.com",
databaseURL: "https://myapp-a3d28-default-rtdb.asia-southeast1.firebasedatabase.app/
    projectId: "myapp-a3d28",
    storageBucket: "myapp-a3d28.firebasestorage.app",
    messagingSenderId: "528024303624",
    appId: "1:528024303624:web:0c5e552d636fd2c93e39bd"
  };
  
firebase.initializeApp(firebaseConfig);
var database = firebase.database();

// USERS
var users = {
  "9111111111": { role: "A", password: "1234" },
  "9222222222": { role: "B", password: "1234" },
  "9988770000": { role: "C", password: "1234" }
};

// ITEM PRICES
var prices = {
  "200 G":20,
  "600 G":51,
  "Pizza":35,
  "Bhajipav":45,
  "Braun 400 G":50
};

let currentUser = "";

// Generate Item Table
let table = document.getElementById("itemTable");
for(let item in prices){
  table.innerHTML += `
    <tr>
      <td>${item}</td>
      <td>â‚¹${prices[item]}</td>
      <td><input type="number" id="${item}" min="0"></td>
    </tr>
  `;
}

// LOGIN
function login(){
  let mobileInput = document.getElementById("mobile").value.trim();
  let passInput   = document.getElementById("password").value.trim();

  if(users[mobileInput] && users[mobileInput].password === passInput){

    currentUser = users[mobileInput].role;

    document.getElementById("loginSection").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("userRole").innerText=currentUser;

    if(currentUser !== "C"){
      document.getElementById("entrySection").style.display="none";
    }

    if(currentUser === "C"){
      document.getElementById("refundSection").style.display="block";
      document.getElementById("refundTitle").style.display="block";
      document.getElementById("settingsBtn").style.display="inline-block";

      let refundItem = document.getElementById("refundItem");
      refundItem.innerHTML="";
      for(let item in prices){
        refundItem.innerHTML += `<option value="${item}">${item}</option>`;
      }
    }

    loadEntries();
    loadRefundHistory();

  } else {
    alert("Invalid Mobile or Password");
  }
}

function logout(){ location.reload(); }

// SUBMIT ENTRY
function submitData(){
  if(currentUser !== "C") return;

  let entryData={}, total=0;

  for(let item in prices){
    let qty=parseInt(document.getElementById(item).value)||0;
    entryData[item]=qty;
    total+=qty*prices[item];
  }

  if(total===0) return alert("Enter quantity");

  database.ref("entries").push({
    items:entryData,
    total:total,
    timestamp:Date.now(),
    status:"pending"
  });
}

// LOAD ENTRIES
function loadEntries(){
  database.ref("entries").on("value", snap=>{
    let data=snap.val()||{}, html="", total=0;
    let refundDropdown=document.getElementById("refundEntry");
    refundDropdown.innerHTML="";

    for(let id in data){
      let e=data[id];
      let d=new Date(e.timestamp);

      html+=`<div class="${e.status}">
      <b>Date:</b> ${d.toLocaleString()}<br>`;

      for(let item in e.items){
        if(e.items[item]>0)
          html+=`${item}: ${e.items[item]}<br>`;
      }

      html+=`<b>Total:</b> â‚¹${e.total}<br>
             <b>Status:</b> ${e.status}`;

      if((currentUser==="A"||currentUser==="B")&&e.status==="pending"){
        html+=`<br><button onclick="confirmEntry('${id}')">Confirm</button>`;
      }

      if(e.status==="confirmed"){
        total+=e.total;
        if(currentUser==="C"){
          refundDropdown.innerHTML+=
            `<option value="${id}">${d.toLocaleDateString()} - â‚¹${e.total}</option>`;
        }
      }

      html+=`</div>`;
    }

    document.getElementById("entries").innerHTML=html;
    document.getElementById("grandTotal").innerText=total;
  });
}

function confirmEntry(id){
  database.ref("entries/"+id).update({status:"confirmed"});
}

// REFUND SYSTEM
function submitRefund(){
  if(currentUser!=="C") return;

  let entryId=refundEntry.value;
  let item=refundItem.value;
  let qty=parseInt(refundQty.value);

  if(!entryId||!qty) return alert("Fill details");

  database.ref("refunds").push({
    entryId,item,qty,
    amount:qty*prices[item],
    timestamp:Date.now(),
    status:"pending"
  });
}

function loadRefundHistory(){
  database.ref("refunds").on("value",snap=>{
    let data=snap.val()||{}, html="";

    for(let id in data){
      let r=data[id];
      let d=new Date(r.timestamp);

      html+=`<div class="${r.status} refundBox">
      <b>Date:</b> ${d.toLocaleString()}<br>
      Item: ${r.item}<br>
      Qty: ${r.qty}<br>
      Amount: â‚¹${r.amount}<br>
      Status: ${r.status}`;

      if((currentUser==="A"||currentUser==="B")&&r.status==="pending"){
        html+=`<br><button onclick="confirmRefund('${id}')">Confirm Refund</button>`;
      }

      html+=`</div>`;
    }

    document.getElementById("refundHistory").innerHTML=
      html||"No refund yet.";
  });
}

function confirmRefund(id){
  database.ref("refunds/"+id).update({status:"confirmed"});
}

// SETTINGS
function toggleSettings(){
  let panel=document.getElementById("settingsPanel");
  panel.style.display=panel.style.display==="none"?"block":"none";
}

function deleteAllEntries(){
  if(confirm("Delete ALL entries?")){
    database.ref("entries").remove();
  }
}

function deleteAllRefunds(){
  if(confirm("Delete ALL refunds?")){
    database.ref("refunds").remove();
  }
}

</script>
</body>
</html>
